test "pipe 0 (no block transfer)" {
    var debug_log = microsim.Debug_Log.init(std.testing.allocator);
    defer debug_log.deinit();
    errdefer debug_log.dump(std.io.getStdErr().writer(), .{ .insn_stuff = true }) catch {};

    var sim = try instructions.init_simulator("park", .p0, &debug_log);
    defer instructions.deinit_simulator(.p0, &sim);

    sim.simulate_reset_and_init();
    sim.simulate_cycles(20);

    try debug_log.expect(.{ .insn_stuff = true },
        \\     3 .zero: rsn = .interrupt_pipe_0
        \\     3 .zero: sr .temp_1 = 0x00000000
        \\     7 .zero: rsn = .interrupt_pipe_0
        \\     7 .zero: sr .temp_1 = 0x00000000
        \\    11 .zero: rsn = .interrupt_pipe_0
        \\    11 .zero: sr .temp_1 = 0x00000000
        \\    15 .zero: sr .zero = 0x00000000
        \\    19 .zero: sr .one = 0x00000001
        \\    23 .zero: sr .temp_1 = 0x00000018
        \\    27 .zero: sr .temp_1 = 0x00003000
        \\    31 .zero: sr .temp_1 = 0x00003001
        \\    35 .zero: sr .temp_1 = 0x03001000
        \\    39 .zero: sr .temp_2 = 0x00000007
        \\    43 .zero: sr .temp_2 = 0x00000070
        \\    47 .zero: sr .temp_2 = 0x0000007E
        \\    51 .zero: sr .temp_2 = 0x0007E000
        \\    55 .zero: write .physical DB:0x0007 DA:0xE000 F:.block_transfer_control_frame AB:0x003 AA:0x003 BbAa   
        \\    59 .zero: read  .physical DB:0x0000 DA:0x0000 F:.block_transfer_control_frame AB:0x003 AA:0x003 BbAa   
        \\    59 .zero: sr .bp = 0x00000000
        \\    67 .zero: read  .physical DB:0x0014 DA:0x0016 F:.zero AB:0x000 AA:0x000 ..Aa   
        \\    67 .zero: sr .next_ip = 0x00000016
        \\    71 .zero: read  .insn DB:0x0202 DA:0xFFFF F:.zero AB:0x005 AA:0x006 Bb.a   
        \\    71 .zero: sr .ip = 0x00000016
        \\
    );
}

test "pipe 1" {
    var debug_log = microsim.Debug_Log.init(std.testing.allocator);
    defer debug_log.deinit();
    errdefer debug_log.dump(std.io.getStdErr().writer(), .{ .insn_stuff = true }) catch {};

    var sim = try instructions.init_simulator("park", .p1, &debug_log);
    defer instructions.deinit_simulator(.p1, &sim);

    sim.simulate_reset_and_init();
    sim.simulate_cycles(20);

    try debug_log.expect(.{ .insn_stuff = true },
        \\     3 .one: rsn = .interrupt_pipe_1
        \\     3 .one: sr .temp_1 = 0x00000001
        \\     7 .one: rsn = .interrupt_pipe_1
        \\     7 .one: sr .temp_1 = 0x00000101
        \\    11 .one: rsn = .interrupt_pipe_1
        \\    11 .one: sr .temp_1 = 0x00000001
        \\    15 .one: sr .zero = 0x00000000
        \\    19 .one: sr .one = 0x00000001
        \\    23 .one: sr .temp_2 = 0x00000080
        \\    27 .one: rsn = 127
        \\    27 .one: sr .one = 0x00000001
        \\    27 .one: sr .rs_reserved = 0x0000007F
        \\    31 .one: sr .zero = 0x00000000
        \\    35 .one: rsn = 126
        \\    35 .one: sr .one = 0x00000001
        \\    35 .one: sr .rs_reserved = 0x0000007E
        \\    39 .one: sr .zero = 0x00000000
        \\    43 .one: rsn = 125
        \\    43 .one: sr .one = 0x00000001
        \\    43 .one: sr .rs_reserved = 0x0000007D
        \\    47 .one: sr .zero = 0x00000000
        \\    51 .one: rsn = 124
        \\    51 .one: sr .one = 0x00000001
        \\    51 .one: sr .rs_reserved = 0x0000007C
        \\    55 .one: sr .zero = 0x00000000
        \\    59 .one: rsn = 123
        \\    59 .one: sr .one = 0x00000001
        \\    59 .one: sr .rs_reserved = 0x0000007B
        \\    63 .one: sr .zero = 0x00000000
        \\    67 .one: rsn = 122
        \\    67 .one: sr .one = 0x00000001
        \\    67 .one: sr .rs_reserved = 0x0000007A
        \\    71 .one: sr .zero = 0x00000000
        \\    75 .one: rsn = 121
        \\    75 .one: sr .one = 0x00000001
        \\    75 .one: sr .rs_reserved = 0x00000079
        \\    79 .one: sr .zero = 0x00000000
        \\    83 .one: rsn = 120
        \\    83 .one: sr .one = 0x00000001
        \\    83 .one: sr .rs_reserved = 0x00000078
        \\    87 .one: sr .zero = 0x00000000
        \\    91 .one: rsn = 119
        \\    91 .one: sr .one = 0x00000001
        \\    91 .one: sr .rs_reserved = 0x00000077
        \\    95 .one: sr .zero = 0x00000000
        \\    99 .one: rsn = 118
        \\    99 .one: sr .one = 0x00000001
        \\    99 .one: sr .rs_reserved = 0x00000076
        \\   103 .one: sr .zero = 0x00000000
        \\   107 .one: rsn = 117
        \\   107 .one: sr .one = 0x00000001
        \\   107 .one: sr .rs_reserved = 0x00000075
        \\   111 .one: sr .zero = 0x00000000
        \\   115 .one: rsn = 116
        \\   115 .one: sr .one = 0x00000001
        \\   115 .one: sr .rs_reserved = 0x00000074
        \\   119 .one: sr .zero = 0x00000000
        \\   123 .one: rsn = 115
        \\   123 .one: sr .one = 0x00000001
        \\   123 .one: sr .rs_reserved = 0x00000073
        \\   127 .one: sr .zero = 0x00000000
        \\   131 .one: rsn = 114
        \\   131 .one: sr .one = 0x00000001
        \\   131 .one: sr .rs_reserved = 0x00000072
        \\   135 .one: sr .zero = 0x00000000
        \\   139 .one: rsn = 113
        \\   139 .one: sr .one = 0x00000001
        \\   139 .one: sr .rs_reserved = 0x00000071
        \\   143 .one: sr .zero = 0x00000000
        \\   147 .one: rsn = 112
        \\   147 .one: sr .one = 0x00000001
        \\   147 .one: sr .rs_reserved = 0x00000070
        \\   151 .one: sr .zero = 0x00000000
        \\   155 .one: rsn = 111
        \\   155 .one: sr .one = 0x00000001
        \\   155 .one: sr .rs_reserved = 0x0000006F
        \\   159 .one: sr .zero = 0x00000000
        \\   163 .one: rsn = 110
        \\   163 .one: sr .one = 0x00000001
        \\   163 .one: sr .rs_reserved = 0x0000006E
        \\   167 .one: sr .zero = 0x00000000
        \\   171 .one: rsn = 109
        \\   171 .one: sr .one = 0x00000001
        \\   171 .one: sr .rs_reserved = 0x0000006D
        \\   175 .one: sr .zero = 0x00000000
        \\   179 .one: rsn = 108
        \\   179 .one: sr .one = 0x00000001
        \\   179 .one: sr .rs_reserved = 0x0000006C
        \\   183 .one: sr .zero = 0x00000000
        \\   187 .one: rsn = 107
        \\   187 .one: sr .one = 0x00000001
        \\   187 .one: sr .rs_reserved = 0x0000006B
        \\   191 .one: sr .zero = 0x00000000
        \\   195 .one: rsn = 106
        \\   195 .one: sr .one = 0x00000001
        \\   195 .one: sr .rs_reserved = 0x0000006A
        \\   199 .one: sr .zero = 0x00000000
        \\   203 .one: rsn = 105
        \\   203 .one: sr .one = 0x00000001
        \\   203 .one: sr .rs_reserved = 0x00000069
        \\   207 .one: sr .zero = 0x00000000
        \\   211 .one: rsn = 104
        \\   211 .one: sr .one = 0x00000001
        \\   211 .one: sr .rs_reserved = 0x00000068
        \\   215 .one: sr .zero = 0x00000000
        \\   219 .one: rsn = 103
        \\   219 .one: sr .one = 0x00000001
        \\   219 .one: sr .rs_reserved = 0x00000067
        \\   223 .one: sr .zero = 0x00000000
        \\   227 .one: rsn = 102
        \\   227 .one: sr .one = 0x00000001
        \\   227 .one: sr .rs_reserved = 0x00000066
        \\   231 .one: sr .zero = 0x00000000
        \\   235 .one: rsn = 101
        \\   235 .one: sr .one = 0x00000001
        \\   235 .one: sr .rs_reserved = 0x00000065
        \\   239 .one: sr .zero = 0x00000000
        \\   243 .one: rsn = 100
        \\   243 .one: sr .one = 0x00000001
        \\   243 .one: sr .rs_reserved = 0x00000064
        \\   247 .one: sr .zero = 0x00000000
        \\   251 .one: rsn = 99
        \\   251 .one: sr .one = 0x00000001
        \\   251 .one: sr .rs_reserved = 0x00000063
        \\   255 .one: sr .zero = 0x00000000
        \\   259 .one: rsn = 98
        \\   259 .one: sr .one = 0x00000001
        \\   259 .one: sr .rs_reserved = 0x00000062
        \\   263 .one: sr .zero = 0x00000000
        \\   267 .one: rsn = 97
        \\   267 .one: sr .one = 0x00000001
        \\   267 .one: sr .rs_reserved = 0x00000061
        \\   271 .one: sr .zero = 0x00000000
        \\   275 .one: rsn = 96
        \\   275 .one: sr .one = 0x00000001
        \\   275 .one: sr .rs_reserved = 0x00000060
        \\   279 .one: sr .zero = 0x00000000
        \\   283 .one: rsn = 95
        \\   283 .one: sr .one = 0x00000001
        \\   283 .one: sr .rs_reserved = 0x0000005F
        \\   287 .one: sr .zero = 0x00000000
        \\   291 .one: rsn = 94
        \\   291 .one: sr .one = 0x00000001
        \\   291 .one: sr .rs_reserved = 0x0000005E
        \\   295 .one: sr .zero = 0x00000000
        \\   299 .one: rsn = 93
        \\   299 .one: sr .one = 0x00000001
        \\   299 .one: sr .rs_reserved = 0x0000005D
        \\   303 .one: sr .zero = 0x00000000
        \\   307 .one: rsn = 92
        \\   307 .one: sr .one = 0x00000001
        \\   307 .one: sr .rs_reserved = 0x0000005C
        \\   311 .one: sr .zero = 0x00000000
        \\   315 .one: rsn = 91
        \\   315 .one: sr .one = 0x00000001
        \\   315 .one: sr .rs_reserved = 0x0000005B
        \\   319 .one: sr .zero = 0x00000000
        \\   323 .one: rsn = 90
        \\   323 .one: sr .one = 0x00000001
        \\   323 .one: sr .rs_reserved = 0x0000005A
        \\   327 .one: sr .zero = 0x00000000
        \\   331 .one: rsn = 89
        \\   331 .one: sr .one = 0x00000001
        \\   331 .one: sr .rs_reserved = 0x00000059
        \\   335 .one: sr .zero = 0x00000000
        \\   339 .one: rsn = 88
        \\   339 .one: sr .one = 0x00000001
        \\   339 .one: sr .rs_reserved = 0x00000058
        \\   343 .one: sr .zero = 0x00000000
        \\   347 .one: rsn = 87
        \\   347 .one: sr .one = 0x00000001
        \\   347 .one: sr .rs_reserved = 0x00000057
        \\   351 .one: sr .zero = 0x00000000
        \\   355 .one: rsn = 86
        \\   355 .one: sr .one = 0x00000001
        \\   355 .one: sr .rs_reserved = 0x00000056
        \\   359 .one: sr .zero = 0x00000000
        \\   363 .one: rsn = 85
        \\   363 .one: sr .one = 0x00000001
        \\   363 .one: sr .rs_reserved = 0x00000055
        \\   367 .one: sr .zero = 0x00000000
        \\   371 .one: rsn = 84
        \\   371 .one: sr .one = 0x00000001
        \\   371 .one: sr .rs_reserved = 0x00000054
        \\   375 .one: sr .zero = 0x00000000
        \\   379 .one: rsn = 83
        \\   379 .one: sr .one = 0x00000001
        \\   379 .one: sr .rs_reserved = 0x00000053
        \\   383 .one: sr .zero = 0x00000000
        \\   387 .one: rsn = 82
        \\   387 .one: sr .one = 0x00000001
        \\   387 .one: sr .rs_reserved = 0x00000052
        \\   391 .one: sr .zero = 0x00000000
        \\   395 .one: rsn = 81
        \\   395 .one: sr .one = 0x00000001
        \\   395 .one: sr .rs_reserved = 0x00000051
        \\   399 .one: sr .zero = 0x00000000
        \\   403 .one: rsn = 80
        \\   403 .one: sr .one = 0x00000001
        \\   403 .one: sr .rs_reserved = 0x00000050
        \\   407 .one: sr .zero = 0x00000000
        \\   411 .one: rsn = 79
        \\   411 .one: sr .one = 0x00000001
        \\   411 .one: sr .rs_reserved = 0x0000004F
        \\   415 .one: sr .zero = 0x00000000
        \\   419 .one: rsn = 78
        \\   419 .one: sr .one = 0x00000001
        \\   419 .one: sr .rs_reserved = 0x0000004E
        \\   423 .one: sr .zero = 0x00000000
        \\   427 .one: rsn = 77
        \\   427 .one: sr .one = 0x00000001
        \\   427 .one: sr .rs_reserved = 0x0000004D
        \\   431 .one: sr .zero = 0x00000000
        \\   435 .one: rsn = 76
        \\   435 .one: sr .one = 0x00000001
        \\   435 .one: sr .rs_reserved = 0x0000004C
        \\   439 .one: sr .zero = 0x00000000
        \\   443 .one: rsn = 75
        \\   443 .one: sr .one = 0x00000001
        \\   443 .one: sr .rs_reserved = 0x0000004B
        \\   447 .one: sr .zero = 0x00000000
        \\   451 .one: rsn = 74
        \\   451 .one: sr .one = 0x00000001
        \\   451 .one: sr .rs_reserved = 0x0000004A
        \\   455 .one: sr .zero = 0x00000000
        \\   459 .one: rsn = 73
        \\   459 .one: sr .one = 0x00000001
        \\   459 .one: sr .rs_reserved = 0x00000049
        \\   463 .one: sr .zero = 0x00000000
        \\   467 .one: rsn = 72
        \\   467 .one: sr .one = 0x00000001
        \\   467 .one: sr .rs_reserved = 0x00000048
        \\   471 .one: sr .zero = 0x00000000
        \\   475 .one: rsn = 71
        \\   475 .one: sr .one = 0x00000001
        \\   475 .one: sr .rs_reserved = 0x00000047
        \\   479 .one: sr .zero = 0x00000000
        \\   483 .one: rsn = 70
        \\   483 .one: sr .one = 0x00000001
        \\   483 .one: sr .rs_reserved = 0x00000046
        \\   487 .one: sr .zero = 0x00000000
        \\   491 .one: rsn = 69
        \\   491 .one: sr .one = 0x00000001
        \\   491 .one: sr .rs_reserved = 0x00000045
        \\   495 .one: sr .zero = 0x00000000
        \\   499 .one: rsn = 68
        \\   499 .one: sr .one = 0x00000001
        \\   499 .one: sr .rs_reserved = 0x00000044
        \\   503 .one: sr .zero = 0x00000000
        \\   507 .one: rsn = 67
        \\   507 .one: sr .one = 0x00000001
        \\   507 .one: sr .rs_reserved = 0x00000043
        \\   511 .one: sr .zero = 0x00000000
        \\   515 .one: rsn = 66
        \\   515 .one: sr .one = 0x00000001
        \\   515 .one: sr .rs_reserved = 0x00000042
        \\   519 .one: sr .zero = 0x00000000
        \\   523 .one: rsn = 65
        \\   523 .one: sr .one = 0x00000001
        \\   523 .one: sr .rs_reserved = 0x00000041
        \\   527 .one: sr .zero = 0x00000000
        \\   531 .one: rsn = 64
        \\   531 .one: sr .one = 0x00000001
        \\   531 .one: sr .rs_reserved = 0x00000040
        \\   535 .one: sr .zero = 0x00000000
        \\   539 .one: rsn = 63
        \\   539 .one: sr .one = 0x00000001
        \\   539 .one: sr .rs_reserved = 0x0000003F
        \\   543 .one: sr .zero = 0x00000000
        \\   547 .one: rsn = 62
        \\   547 .one: sr .one = 0x00000001
        \\   547 .one: sr .rs_reserved = 0x0000003E
        \\   551 .one: sr .zero = 0x00000000
        \\   555 .one: rsn = 61
        \\   555 .one: sr .one = 0x00000001
        \\   555 .one: sr .rs_reserved = 0x0000003D
        \\   559 .one: sr .zero = 0x00000000
        \\   563 .one: rsn = 60
        \\   563 .one: sr .one = 0x00000001
        \\   563 .one: sr .rs_reserved = 0x0000003C
        \\   567 .one: sr .zero = 0x00000000
        \\   571 .one: rsn = 59
        \\   571 .one: sr .one = 0x00000001
        \\   571 .one: sr .rs_reserved = 0x0000003B
        \\   575 .one: sr .zero = 0x00000000
        \\   579 .one: rsn = 58
        \\   579 .one: sr .one = 0x00000001
        \\   579 .one: sr .rs_reserved = 0x0000003A
        \\   583 .one: sr .zero = 0x00000000
        \\   587 .one: rsn = 57
        \\   587 .one: sr .one = 0x00000001
        \\   587 .one: sr .rs_reserved = 0x00000039
        \\   591 .one: sr .zero = 0x00000000
        \\   595 .one: rsn = 56
        \\   595 .one: sr .one = 0x00000001
        \\   595 .one: sr .rs_reserved = 0x00000038
        \\   599 .one: sr .zero = 0x00000000
        \\   603 .one: rsn = 55
        \\   603 .one: sr .one = 0x00000001
        \\   603 .one: sr .rs_reserved = 0x00000037
        \\   607 .one: sr .zero = 0x00000000
        \\   611 .one: rsn = 54
        \\   611 .one: sr .one = 0x00000001
        \\   611 .one: sr .rs_reserved = 0x00000036
        \\   615 .one: sr .zero = 0x00000000
        \\   619 .one: rsn = 53
        \\   619 .one: sr .one = 0x00000001
        \\   619 .one: sr .rs_reserved = 0x00000035
        \\   623 .one: sr .zero = 0x00000000
        \\   627 .one: rsn = 52
        \\   627 .one: sr .one = 0x00000001
        \\   627 .one: sr .rs_reserved = 0x00000034
        \\   631 .one: sr .zero = 0x00000000
        \\   635 .one: rsn = 51
        \\   635 .one: sr .one = 0x00000001
        \\   635 .one: sr .rs_reserved = 0x00000033
        \\   639 .one: sr .zero = 0x00000000
        \\   643 .one: rsn = 50
        \\   643 .one: sr .one = 0x00000001
        \\   643 .one: sr .rs_reserved = 0x00000032
        \\   647 .one: sr .zero = 0x00000000
        \\   651 .one: rsn = 49
        \\   651 .one: sr .one = 0x00000001
        \\   651 .one: sr .rs_reserved = 0x00000031
        \\   655 .one: sr .zero = 0x00000000
        \\   659 .one: rsn = 48
        \\   659 .one: sr .one = 0x00000001
        \\   659 .one: sr .rs_reserved = 0x00000030
        \\   663 .one: sr .zero = 0x00000000
        \\   667 .one: rsn = 47
        \\   667 .one: sr .one = 0x00000001
        \\   667 .one: sr .rs_reserved = 0x0000002F
        \\   671 .one: sr .zero = 0x00000000
        \\   675 .one: rsn = 46
        \\   675 .one: sr .one = 0x00000001
        \\   675 .one: sr .rs_reserved = 0x0000002E
        \\   679 .one: sr .zero = 0x00000000
        \\   683 .one: rsn = 45
        \\   683 .one: sr .one = 0x00000001
        \\   683 .one: sr .rs_reserved = 0x0000002D
        \\   687 .one: sr .zero = 0x00000000
        \\   691 .one: rsn = 44
        \\   691 .one: sr .one = 0x00000001
        \\   691 .one: sr .rs_reserved = 0x0000002C
        \\   695 .one: sr .zero = 0x00000000
        \\   699 .one: rsn = 43
        \\   699 .one: sr .one = 0x00000001
        \\   699 .one: sr .rs_reserved = 0x0000002B
        \\   703 .one: sr .zero = 0x00000000
        \\   707 .one: rsn = 42
        \\   707 .one: sr .one = 0x00000001
        \\   707 .one: sr .rs_reserved = 0x0000002A
        \\   711 .one: sr .zero = 0x00000000
        \\   715 .one: rsn = 41
        \\   715 .one: sr .one = 0x00000001
        \\   715 .one: sr .rs_reserved = 0x00000029
        \\   719 .one: sr .zero = 0x00000000
        \\   723 .one: rsn = 40
        \\   723 .one: sr .one = 0x00000001
        \\   723 .one: sr .rs_reserved = 0x00000028
        \\   727 .one: sr .zero = 0x00000000
        \\   731 .one: rsn = 39
        \\   731 .one: sr .one = 0x00000001
        \\   731 .one: sr .rs_reserved = 0x00000027
        \\   735 .one: sr .zero = 0x00000000
        \\   739 .one: rsn = 38
        \\   739 .one: sr .one = 0x00000001
        \\   739 .one: sr .rs_reserved = 0x00000026
        \\   743 .one: sr .zero = 0x00000000
        \\   747 .one: rsn = 37
        \\   747 .one: sr .one = 0x00000001
        \\   747 .one: sr .rs_reserved = 0x00000025
        \\   751 .one: sr .zero = 0x00000000
        \\   755 .one: rsn = 36
        \\   755 .one: sr .one = 0x00000001
        \\   755 .one: sr .rs_reserved = 0x00000024
        \\   759 .one: sr .zero = 0x00000000
        \\   763 .one: rsn = 35
        \\   763 .one: sr .one = 0x00000001
        \\   763 .one: sr .rs_reserved = 0x00000023
        \\   767 .one: sr .zero = 0x00000000
        \\   771 .one: rsn = 34
        \\   771 .one: sr .one = 0x00000001
        \\   771 .one: sr .rs_reserved = 0x00000022
        \\   775 .one: sr .zero = 0x00000000
        \\   779 .one: rsn = 33
        \\   779 .one: sr .one = 0x00000001
        \\   779 .one: sr .rs_reserved = 0x00000021
        \\   783 .one: sr .zero = 0x00000000
        \\   787 .one: rsn = 32
        \\   787 .one: sr .one = 0x00000001
        \\   787 .one: sr .rs_reserved = 0x00000020
        \\   791 .one: sr .zero = 0x00000000
        \\   795 .one: rsn = 31
        \\   795 .one: sr .one = 0x00000001
        \\   795 .one: sr .rs_reserved = 0x0000001F
        \\   799 .one: sr .zero = 0x00000000
        \\   803 .one: rsn = 30
        \\   803 .one: sr .one = 0x00000001
        \\   803 .one: sr .rs_reserved = 0x0000001E
        \\   807 .one: sr .zero = 0x00000000
        \\   811 .one: rsn = 29
        \\   811 .one: sr .one = 0x00000001
        \\   811 .one: sr .rs_reserved = 0x0000001D
        \\   815 .one: sr .zero = 0x00000000
        \\   819 .one: rsn = 28
        \\   819 .one: sr .one = 0x00000001
        \\   819 .one: sr .rs_reserved = 0x0000001C
        \\   823 .one: sr .zero = 0x00000000
        \\   827 .one: rsn = 27
        \\   827 .one: sr .one = 0x00000001
        \\   827 .one: sr .rs_reserved = 0x0000001B
        \\   831 .one: sr .zero = 0x00000000
        \\   835 .one: rsn = 26
        \\   835 .one: sr .one = 0x00000001
        \\   835 .one: sr .rs_reserved = 0x0000001A
        \\   839 .one: sr .zero = 0x00000000
        \\   843 .one: rsn = 25
        \\   843 .one: sr .one = 0x00000001
        \\   843 .one: sr .rs_reserved = 0x00000019
        \\   847 .one: sr .zero = 0x00000000
        \\   851 .one: rsn = 24
        \\   851 .one: sr .one = 0x00000001
        \\   851 .one: sr .rs_reserved = 0x00000018
        \\   855 .one: sr .zero = 0x00000000
        \\   859 .one: rsn = 23
        \\   859 .one: sr .one = 0x00000001
        \\   859 .one: sr .rs_reserved = 0x00000017
        \\   863 .one: sr .zero = 0x00000000
        \\   867 .one: rsn = 22
        \\   867 .one: sr .one = 0x00000001
        \\   867 .one: sr .rs_reserved = 0x00000016
        \\   871 .one: sr .zero = 0x00000000
        \\   875 .one: rsn = 21
        \\   875 .one: sr .one = 0x00000001
        \\   875 .one: sr .rs_reserved = 0x00000015
        \\   879 .one: sr .zero = 0x00000000
        \\   883 .one: rsn = 20
        \\   883 .one: sr .one = 0x00000001
        \\   883 .one: sr .rs_reserved = 0x00000014
        \\   887 .one: sr .zero = 0x00000000
        \\   891 .one: rsn = 19
        \\   891 .one: sr .one = 0x00000001
        \\   891 .one: sr .rs_reserved = 0x00000013
        \\   895 .one: sr .zero = 0x00000000
        \\   899 .one: rsn = 18
        \\   899 .one: sr .one = 0x00000001
        \\   899 .one: sr .rs_reserved = 0x00000012
        \\   903 .one: sr .zero = 0x00000000
        \\   907 .one: rsn = 17
        \\   907 .one: sr .one = 0x00000001
        \\   907 .one: sr .rs_reserved = 0x00000011
        \\   911 .one: sr .zero = 0x00000000
        \\   915 .one: rsn = 16
        \\   915 .one: sr .one = 0x00000001
        \\   915 .one: sr .rs_reserved = 0x00000010
        \\   919 .one: sr .zero = 0x00000000
        \\   923 .one: rsn = 15
        \\   923 .one: sr .one = 0x00000001
        \\   923 .one: sr .rs_reserved = 0x0000000F
        \\   927 .one: sr .zero = 0x00000000
        \\   931 .one: rsn = 14
        \\   931 .one: sr .one = 0x00000001
        \\   931 .one: sr .rs_reserved = 0x0000000E
        \\   935 .one: sr .zero = 0x00000000
        \\   939 .one: rsn = 13
        \\   939 .one: sr .one = 0x00000001
        \\   939 .one: sr .rs_reserved = 0x0000000D
        \\   943 .one: sr .zero = 0x00000000
        \\   947 .one: rsn = 12
        \\   947 .one: sr .one = 0x00000001
        \\   947 .one: sr .rs_reserved = 0x0000000C
        \\   951 .one: sr .zero = 0x00000000
        \\   955 .one: rsn = 11
        \\   955 .one: sr .one = 0x00000001
        \\   955 .one: sr .rs_reserved = 0x0000000B
        \\   959 .one: sr .zero = 0x00000000
        \\   963 .one: rsn = 10
        \\   963 .one: sr .one = 0x00000001
        \\   963 .one: sr .rs_reserved = 0x0000000A
        \\   967 .one: sr .zero = 0x00000000
        \\   971 .one: rsn = 9
        \\   971 .one: sr .one = 0x00000001
        \\   971 .one: sr .rs_reserved = 0x00000009
        \\   975 .one: sr .zero = 0x00000000
        \\   979 .one: rsn = 8
        \\   979 .one: sr .one = 0x00000001
        \\   979 .one: sr .rs_reserved = 0x00000008
        \\   983 .one: sr .zero = 0x00000000
        \\   987 .one: rsn = 7
        \\   987 .one: sr .one = 0x00000001
        \\   987 .one: sr .rs_reserved = 0x00000007
        \\   991 .one: sr .zero = 0x00000000
        \\   995 .one: rsn = 6
        \\   995 .one: sr .one = 0x00000001
        \\   995 .one: sr .rs_reserved = 0x00000006
        \\   999 .one: sr .zero = 0x00000000
        \\  1003 .one: rsn = 5
        \\  1003 .one: sr .one = 0x00000001
        \\  1003 .one: sr .rs_reserved = 0x00000005
        \\  1007 .one: sr .zero = 0x00000000
        \\  1011 .one: rsn = 4
        \\  1011 .one: sr .one = 0x00000001
        \\  1011 .one: sr .rs_reserved = 0x00000004
        \\  1015 .one: sr .zero = 0x00000000
        \\  1019 .one: rsn = .interrupt_pipe_3
        \\  1019 .one: sr .one = 0x00000001
        \\  1019 .one: sr .rs_reserved = 0x00000003
        \\  1023 .one: sr .zero = 0x00000000
        \\  1027 .one: rsn = .interrupt_pipe_2
        \\  1027 .one: sr .one = 0x00000001
        \\  1027 .one: sr .rs_reserved = 0x00000002
        \\  1031 .one: sr .zero = 0x00000000
        \\  1035 .one: rsn = .interrupt_pipe_1
        \\  1035 .one: sr .one = 0x00000001
        \\  1035 .one: sr .rs_reserved = 0x00000001
        \\  1039 .one: sr .zero = 0x00000000
        \\  1043 .one: rsn = .interrupt_pipe_0
        \\  1043 .one: sr .one = 0x00000001
        \\  1043 .one: sr .rs_reserved = 0x00000000
        \\  1047 .one: rsn = .interrupt_pipe_1
        \\  1051 .one: sr .temp_1 = 0x00000002
        \\  1055 .one: sr .temp_1 = 0x00000200
        \\
    );
}

test "pipe 2" {
    var debug_log = microsim.Debug_Log.init(std.testing.allocator);
    defer debug_log.deinit();
    errdefer debug_log.dump(std.io.getStdErr().writer(), .{ .insn_stuff = true }) catch {};

    var sim = try instructions.init_simulator("park", .p2, &debug_log);
    defer instructions.deinit_simulator(.p2, &sim);

    sim.simulate_reset_and_init();
    sim.simulate_cycles(20);

    try debug_log.expect(.{ .insn_stuff = true },
        \\     3 .two: rsn = .interrupt_pipe_2
        \\     3 .two: sr .temp_1 = 0x00000002
        \\     7 .two: rsn = .interrupt_pipe_2
        \\     7 .two: sr .temp_1 = 0x00000202
        \\    11 .two: rsn = .interrupt_pipe_2
        \\    11 .two: sr .temp_1 = 0x00000002
        \\    15 .two: sr .zero = 0x00000000
        \\    19 .two: sr .one = 0x00000001
        \\    27 .two: sr .temp_1 = 0x00000002
        \\    31 .two: sr .temp_1 = 0x00000200
        \\
    );
}

test "pipe 3" {
    var debug_log = microsim.Debug_Log.init(std.testing.allocator);
    defer debug_log.deinit();
    errdefer debug_log.dump(std.io.getStdErr().writer(), .{ .insn_stuff = true }) catch {};

    var sim = try instructions.init_simulator("park", .p3, &debug_log);
    defer instructions.deinit_simulator(.p3, &sim);

    sim.simulate_reset_and_init();
    sim.simulate_cycles(20);

    try debug_log.expect(.{ .insn_stuff = true },
        \\     3 .three: rsn = .interrupt_pipe_3
        \\     3 .three: sr .temp_1 = 0x00000003
        \\     7 .three: rsn = .interrupt_pipe_3
        \\     7 .three: sr .temp_1 = 0x00000303
        \\    11 .three: rsn = .interrupt_pipe_3
        \\    11 .three: sr .temp_1 = 0x00000003
        \\    15 .three: sr .zero = 0x00000000
        \\    19 .three: sr .one = 0x00000001
        \\    27 .three: sr .temp_1 = 0x00000002
        \\    31 .three: sr .temp_1 = 0x00000200
        \\
    );
}

const expect = std.testing.expect;
const expectEqual = std.testing.expectEqual;

const instructions = @import("../instructions.zig");
const microsim = @import("microsim");
const arch = @import("arch");
const std = @import("std");
